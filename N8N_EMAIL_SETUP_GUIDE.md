# N8N Email Webhook Setup Guide

## Webhook URL
`https://n8n.eventplanners.cloud/webhook/d3ce78b4-3da7-4efd-92aa-b0c154f5858b`

## What Flask Sends to N8N

```json
{
  "recipient_email": "mehroz.muneer@gmail.com",
  "csv_content": "Company,First Name,Last Name,Title,Email,Website,Document 1,Document 2\nEMRG Media,John,Doe,...",
  "csv_base64": "Q29tcGFueSxGaXJzdCBOYW1lLExhc3QgTmFtZS4uLg==",
  "filename": "dream100_results_20260105_002030.csv",
  "subject": "Dream 100 Batch Processing Results - 2026-01-05 00:20",
  "batch_id": "79b078b5-a71a-42f6-ac8f-eb15c4341299"
}
```

## N8N Workflow Configuration

### Node 1: Webhook Trigger
- **Type**: Webhook
- **HTTP Method**: POST
- **Path**: `d3ce78b4-3da7-4efd-92aa-b0c154f5858b`
- **Response Mode**: Last Node

### Node 2: Function - Prepare Email Data
**Code:**
```javascript
// Extract data from webhook
const recipientEmail = $input.item.json.recipient_email;
const csvBase64 = $input.item.json.csv_base64;
const filename = $input.item.json.filename;
const subject = $input.item.json.subject;
const batchId = $input.item.json.batch_id;

// Create email body
const emailBody = `
<h2>ðŸŽ¯ Dream 100 Batch Processing Complete</h2>

<p>Your batch processing (ID: ${batchId}) has finished successfully!</p>

<p>The attached CSV file contains:</p>
<ul>
  <li>âœ… Company information</li>
  <li>âœ… Contact details (Name, Title, Email)</li>
  <li>âœ… Website URLs</li>
  <li>ðŸ“„ Pre-Brief Document Links</li>
  <li>ðŸ“Š Sales Snapshot Document Links</li>
</ul>

<p><strong>File:</strong> ${filename}</p>

<hr>
<p style="color: #666; font-size: 12px;">
Generated by Dream 100 Advantage - Prospect Intelligence System
</p>
`;

return {
  json: {
    to: recipientEmail,
    subject: subject,
    body: emailBody,
    attachmentData: csvBase64,
    attachmentName: filename
  }
};
```

### Node 3: Gmail - Send Email
**Configuration:**

- **Resource**: Message
- **Operation**: Send

**Fields:**
- **To**: `={{ $json.to }}`
- **Subject**: `={{ $json.subject }}`
- **Email Type**: HTML
- **Message**: `={{ $json.body }}`

**Attachments:**
- **Add Attachment**: Yes
- **Attachment Input**: Binary Data
- **Binary Property**: Create from expression
- **Expression**: `={{ Buffer.from($json.attachmentData, 'base64') }}`
- **File Name**: `={{ $json.attachmentName }}`

**OR (Alternative - Simpler Approach):**

- **Attachments**: Use Expression
- **Value**:
```javascript
[{
  "type": "Buffer",
  "data": "={{ Buffer.from($json.attachmentData, 'base64').toJSON().data }}"
}]
```

## Alternative: Using Gmail API Direct Attachment

If the above doesn't work, use this approach:

### Node 3 Alternative: Gmail Send with Base64 Attachment

```javascript
// In Function node, add this:
const attachment = {
  mimeType: 'text/csv',
  filename: filename,
  data: csvBase64
};

return {
  json: {
    to: recipientEmail,
    subject: subject,
    body: emailBody,
    attachments: [attachment]
  }
};
```

## Testing the Email Webhook

You can test the webhook directly with curl:

```bash
curl -X POST https://n8n.eventplanners.cloud/webhook/d3ce78b4-3da7-4efd-92aa-b0c154f5858b \
  -H "Content-Type: application/json" \
  -d '{
    "recipient_email": "mehroz.muneer@gmail.com",
    "csv_content": "Company,First Name,Last Name,Title,Email,Website,Document 1,Document 2\nTest Company,John,Doe,CEO,john@test.com,https://test.com,https://docs.google.com/doc1,https://docs.google.com/doc2",
    "csv_base64": "Q29tcGFueSxGaXJzdCBOYW1lLExhc3QgTmFtZSxUaXRsZSxFbWFpbCxXZWJzaXRlLERvY3VtZW50IDEsRG9jdW1lbnQgMgpUZXN0IENvbXBhbnksSm9obixEb2UsQ0VPLGpvaG5AdGVzdC5jb20saHR0cHM6Ly90ZXN0LmNvbSxodHRwczovL2RvY3MuZ29vZ2xlLmNvbS9kb2MxLGh0dHBzOi8vZG9jcy5nb29nbGUuY29tL2RvYzI=",
    "filename": "test_results.csv",
    "subject": "Test - Dream 100 Results",
    "batch_id": "test-123"
  }'
```

## Troubleshooting

### Issue: Attachment not appearing
**Solution**: Make sure Gmail node has "Send Attachments" enabled

### Issue: CSV file corrupted
**Solution**: Verify base64 encoding is correct. Test with:
```bash
echo "Q29tcGFueSxGaXJzdCBOYW1l..." | base64 -d
```

### Issue: Email not sending
**Solution**:
1. Check Gmail credentials in N8N
2. Verify webhook is activated
3. Check N8N execution logs

## Complete N8N Workflow JSON

See `n8n_email_workflow_updated.json` for importable workflow.
